<% content_for :title, "Dicty12: Update Registration" %>
<p id="notice"><%= notice %></p>

<h3>Editing registration</h3>

<%#= javascript_include_tag "http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js" %>
<%#= javascript_include_tag :defaults %> <!-- Issue with rails.js. Hence using jQuery.min.js -->
<%= javascript_include_tag "jquery", "jquery-ui-datepicker", "money-min" %>
<%= stylesheet_link_tag "jquery-ui-datepicker" %>

<script type="text/javascript">

    var oneDay  = 24*60*60*1000;
    var to_currency = ''

    $(document).ready(function() {

        // var dicty12Dates = ["7-29-2012", "7-30-2012", "7-31-2012", "8-1-2012", "8-2-2012"];
        
        // function dictyMeetingDays(date) {
        //     var dateAsString = (date.getMonth()+1) + "-" + date.getDate() + "-" + date.getFullYear();
        //     if ($.inArray(dateAsString, dicty12Dates) < 0) {
        //         return [true,"","Book Now"];
        //     } else {
        //         return [false,"","Dicty12"];
        //     }
        // }

        $('#user_check_in').datepicker(
            { 
                dateFormat: 'MM d, yy',
                minDate: new Date(2012, 7-1, 15),
                maxDate: new Date(2012, 8-1, 15),
                showWeek: true,
                numberOfMonths: 2//,
                //beforeShowDay: dictyMeetingDays
            });
        $( '#user_check_out' ).datepicker(
            { 
                dateFormat: 'MM d, yy',
                minDate: new Date(2012, 7-1, 15),
                maxDate: new Date(2012, 8-1, 15),
                showWeek: true,
                numberOfMonths: 2//,
                //beforeShowDay: dictyMeetingDays
            });

        $('#user_has_guest').attr('checked', false)
        $('#user_has_guest').attr('disabled', true)
        $("#user_has_guest").click(function() {
            showGuestOptions()
        })

        $('#extra_view_price').hide()
        $('#extra_view_price').val('')
        $('#user_check_in').hide()
        $('#user_check_out').hide()
        $('#user_extra_accommodation').attr('checked', false)
        $("#user_extra_accommodation").click(function() {
            showExtraAccOptions()   
        })

        $('#user_guest_trip').hide()
        $('#user_guest_supplement_HB').hide()
        $('#user_guest_supplement_HBD').hide()
        $('label[for="label_guest_dinner_trip"]').hide()
        $('label[for="label_guest_supplement_1"]').hide()
        $('label[for="label_guest_supplement_2"]').hide()

        $('#view_price').hide()
        $('#user_roomie_first_name').hide()
        $('#user_roomie_last_name').hide()
        $('label[for="label_roomie_name"]').hide()

        $("input[type=radio]").attr('checked', false)
        $("input[type=radio]").click(function() {
            showPrice()
        })

        $('#user_payment_due').val('')  
        $('#user_payment_due').hide() 
        $('#user_payment_due').css({ 'font-weight': 'bold', 'font-size': '12px', 'color':'black', 'border': 'none', 'background-color':'white' });
        $('label[for="user_payment_due"]').hide()

        $('#converted_currency').hide();
        $('#converted_currency').val('');
        $('#converted_currency').css({ //'font-weight': 'bold', 
            'font-size': '12px', 'color':'black', 'border': 'none', 'background-color':'white' });
        $('select#to_currency').hide();
        $('select#to_currency').click(function() {
            to_currency = $('select#to_currency :selected').val();
        });
    });

    $.getJSON(
        'http://openexchangerates.org/latest.json',
        function(data) {
            if ( typeof fx !== "undefined" && fx.rates ) {
                fx.rates = data.rates;
                fx.base = data.base;
            } else {
                var fxSetup = {
                    rates : data.rates,
                    base : data.base
                }
            }
        }
    );

    $(document).click(function() {
        paymentDue()
    });

    

    function paymentDue () {
        var final_amount = 0;
        $('#user_payment_due').show()
        $('label[for="user_payment_due"]').show()
        $('#converted_currency').show();
        $('select#to_currency').show();
        
        if ($('#user_accommodation_type_single_use').is(':checked')) {
            if (getRegistrationType() == 'Early Registration'){
                final_amount += 830; 
            } else if (getRegistrationType() == 'Late Registration') {
                final_amount += 950; 
            }   
        } else if ($('#user_accommodation_type_double_use').is(':checked')) {
            if (getRegistrationType() == 'Early Registration'){
                final_amount += 675 * 2;
            } else if (getRegistrationType() == 'Late Registration') {
                final_amount += 795 * 2;
            }  
        }

        if ($('#user_has_guest').is(':checked')) {
            if ($('#user_guest_supplement_HB').is(':checked')){
                final_amount += 207;    
            } else if ($('#user_guest_supplement_HBD').is(':checked')){
                final_amount += 327;    
            } 
            if ($('#user_guest_trip').is(':checked')){
                final_amount += 63;    
            } 
        } 

        if ($('#user_extra_accommodation').is(':checked')){
            var num_days = 0;
            
            var checkin = new Date($('#user_check_in').val())
            var checkout = new Date($('#user_check_out').val())
            num_days = getNonDictyDays(checkin, checkout)

            if ($('#user_accommodation_type_single_use').is(':checked') && $('#user_check_in').val() != '' && $('#user_check_out').val() != '') {
                final_amount += 90.72 * num_days;      
            } else if ($('#user_accommodation_type_double_use').is(':checked') && $('#user_check_in').val() != '' && $('#user_check_out').val() != '') {
                final_amount += 103.68 * num_days;     
            }    
        }     

        $('#user_payment_due').val('€' + final_amount.toFixed(2)); 

        var converted = 0
        if (to_currency != ''){
            converted = fx.convert(final_amount, {from: "EUR", to: to_currency}).toFixed(2);
        }  
        $('#converted_currency').val(converted);       
    }

    function getNonDictyDays (startDate, endDate) {
        var dicty12Start = new Date(2012, 7-1, 29);
        var dicty12End = new Date (2012, 8-1, 2);
        var days = 0

        if ((startDate < dicty12Start) && (endDate <= dicty12End) && (endDate > dicty12Start)){
            days = Math.abs((dicty12Start.getTime() - startDate.getTime()) / oneDay);
        } else if ((startDate >= dicty12Start) && (dicty12End < endDate) && (startDate < dicty12End)) {
            days = Math.abs((endDate.getTime() - dicty12End.getTime()) / oneDay);
        } else if ((startDate < dicty12Start) && (endDate < dicty12End)) {
            days = 0;
        } else if ((startDate < dicty12Start) && (endDate > dicty12End)) {
            days = Math.abs((dicty12Start.getTime() - startDate.getTime()) / oneDay) + Math.abs((endDate.getTime() - dicty12End.getTime()) / oneDay);
        }
        return days;
    }

    function showExtraAccOptions() {
        $('#extra_view_price').css({ 'font-weight': 'bold', 'font-size': '12px', 'color':'black', 'border': 'none', 'background-color':'white' });
        if ($('#user_extra_accommodation').is(':checked')){
            $('#extra_view_price').show()
            $('#user_check_in').show()
            $('#user_check_out').show()
        } else {
            $('#extra_view_price').hide()   
            $('#user_check_in').hide()
            $('#user_check_out').hide()
            $('#user_check_in').val('')
            $('#user_check_out').val('')
        }
    }

    function getRegistrationType() {
        var registration_type;
        if (Date.now() < Date.parse("5/15/2012")) {
            registration_type = 'Early Registration'   
        } else if (Date.now() > Date.parse("5/15/2012") && Date.now() <  Date.parse("7/23/2012")) {
            registration_type = 'Late Registration'
        }    
        return registration_type;
    }

    function showPrice() {
        $('#view_price').show()
        $('#view_price').css({ 'font-weight': 'bold', 'font-size': '12px', 'color':'black', 'border': 'none', 'background-color':'white' });

        if ($('#user_accommodation_type_double_use').is(':checked')) {
            $('label[for="label_roomie_name"]').show()
            $('#user_roomie_first_name').show()
            $('#user_roomie_last_name').show()

            $('#user_has_guest').attr('disabled', false)
        
            $('#extra_view_price').val('€103.68 (per night)')

            if (getRegistrationType() == 'Early Registration'){
                $('#view_price').val('Early Registration: €675 (per person)')
            } else if (getRegistrationType() == 'Late Registration') {
                $('#view_price').val('Late Registration: €795 (per person)')
            }
        } else if ($('#user_accommodation_type_single_use').is(':checked')) {
            $('#user_roomie_first_name').hide()
            $('#user_roomie_last_name').hide()
            $('label[for="label_roomie_name"]').hide()

            $('#user_has_guest').attr('checked', false)
            $('#user_has_guest').attr('disabled', true)
            $('#user_guest_trip').hide()
            $('#user_guest_supplement_HB').hide()
            $('#user_guest_supplement_HBD').hide()
            $('label[for="label_guest_dinner_trip"]').hide()
            $('label[for="label_guest_supplement_1"]').hide()
            $('label[for="label_guest_supplement_2"]').hide()

            $('#extra_view_price').val('€90.72 (per night)')

            if (getRegistrationType() == 'Early Registration'){
                $('#view_price').val('Early Registration: €830')
            } else if (getRegistrationType() == 'Late Registration') {
                $('#view_price').val('Late Registration: €950')
            }
        }

        $('#user_accommodation_type_single_use').click(function() {
            $('#user_roomie_first_name').val('')
            $('#user_roomie_last_name').val('')
        })
    }

    function showGuestOptions() {
        if ($('#user_has_guest').is(':checked')){
            $('#user_guest_trip').show()
            $('#user_guest_supplement_HB').show()
            $('#user_guest_supplement_HBD').show()
            $('label[for="label_guest_dinner_trip"]').show()
            $('label[for="label_guest_supplement_1"]').show()
            $('label[for="label_guest_supplement_2"]').show()
        }else {
            $('#user_guest_trip').attr('checked', false)
            $('#user_guest_trip').hide()
            $('#user_guest_supplement_HB').attr('checked', false)
            $('#user_guest_supplement_HB').hide()
            $('#user_guest_supplement_HBD').attr('checked', false)
            $('#user_guest_supplement_HBD').hide()
            $('label[for="label_guest_dinner_trip"]').hide ()
            $('label[for="label_guest_supplement_1"]').hide ()
            $('label[for="label_guest_supplement_2"]').hide ()
          }

        $('#user_guest_supplement_HB').click(function() {
            $('#user_guest_supplement_HB').attr('checked', true)
            $('#user_guest_supplement_HBD').attr('checked', false)
        })

        $('#user_guest_supplement_HBD').click(function() {
            $('#user_guest_supplement_HB').attr('checked', false)
            $('#user_guest_supplement_HBD').attr('checked', true)
        })
    }

</script>


<%= form_for @user, :html => {:multipart => true, :method => 'put'} do |f| %>
  
    <% if @user.errors.any? %>
        <div id="error_explanation">
            <h2>We have <%= pluralize(@user.errors.count, "error") %> on the form</h2>
            <ul>
                <% @user.errors.full_messages.each do |msg| %>
                    <li><%= msg %></li>
                <% end %>
            </ul>
        </div>   
    <% end %>

  <%#= session[:where_from] %>
  
    <table>
        <tr>
            <td><%= f.label :first_name %></td>
            <td><%= f.text_field :first_name, :required => true, :mark => '*' %></td>
        </tr>
        <tr>
            <td><%= f.label :last_name %></td>
            <td><%= f.text_field :last_name, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :email %></td>
            <td><%= f.text_field :email, :disabled=>true, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :institute, "Institute Affiliation" %></td>
            <td><%= f.text_field :institute, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :address %></td>
            <td><%= f.text_field :address, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :city %></td>
            <td><%= f.text_field :city, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :zipcode %></td>
            <td><%= f.text_field :zipcode, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :country %></td>
            <td><%= f.text_field :country, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :phone %></td>
            <td><%= f.text_field :phone, :required => true %></td>
        </tr>
        <tr>
            <td><%= f.label :billing_id, 'VAT number/Tax exempt ID' %></td>
            <td><%= f.text_field :billing_id, :required => true %></td>
        </tr>
        <!--
        <tr>
            <td>Passport #</td>
            <td><%#= f.text_field :passport, :required => true %></td>
        </tr>
        -->
        <tr>
            <td>
                <label for="accommodation_type">Accommodation</label>
            </td>
            <td>
                <%# [ 'Single use', 'Double use' ].each do |accommodation_type| %>
                  <%= f.radio_button(:accommodation_type, 'Single use', :required => true )%>
                  <%= label_tag 'single_use', 'Single use' %>
                  <%= f.radio_button(:accommodation_type, 'Double use', :required => true ) %>
                  <%= label_tag 'double_use', 'Double use' %>
                    <%#= f.radio_button 'accommodation_type', accommodation_type, :default => 'Single use', %>
                    <%#= accommodation_type.humanize %>
                <%# end %>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
              <%= text_field_tag 'view_price', '', :disabled=>true, :size => "45", :color => 'black' %>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
              <%= label_tag 'label_roomie_name', 'Person to share room:' %>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
              <%= f.text_field :roomie_first_name, :placeholder => "First Name", :size => "25" %>
              <%= f.text_field :roomie_last_name, :placeholder => "Last Name", :size => "25" %>
            </td>
        </tr>
        <tr>
            <td><%= label_tag 'Will you require extra accommodation?' %></td>
            <td>
                <%= f.check_box(:extra_accommodation, :default => false ) %>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
              <%= text_field_tag 'extra_view_price', '', :disabled=>true, :size => "45", :color => 'black' %>
            </td>
        </tr>
        <tr>
            <td></td>
            <td>
                <%= f.text_field :check_in, :placeholder => "Check-in", :size => "25" %>
                <%= f.text_field :check_out, :placeholder => "Check-out", :size => "25" %>
            </td>
        </tr>
        <tr>
            <td><%= label_tag 'Have an accompanying guest?' %></td>
            <td><%= f.check_box(:has_guest, :default => false, :onclick => 'showGuestOptions()') %></td>
          </tr>
        <tr>
            <td></td>
            <td>
              <%= f.check_box :guest_supplement_HB %>
              <%= label_tag 'label_guest_supplement_1', 'Accommodation Supplement (Hotel + Breakfast): €207' %>
            </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <%= f.check_box :guest_supplement_HBD %>
            <%= label_tag 'label_guest_supplement_2', 'Accommodation Supplement (Hotel + Breakfast + Dinner): €327' %>
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <%= f.check_box :guest_trip %>
            <%= label_tag 'label_guest_dinner_trip', 'Trip to Segovia (with Dinner): €63', :type => 'text' %>
          </td>
        </tr>
        <tr>
          <td><%= label_tag 'label_comments', 'Comments', :type => 'text' %></td>
          <td>
            <%= f.text_area :comment, :rows => 5, :cols => 26 %>
          </td>
        </tr>
        <tr>
            <td><hr /></td>
            <td><hr /></td>
        </tr>
        <tr>
          <td><%= f.label :payment_due, 'Total Amount Due' %></td>
          <td>
            <table>
            <tr>
                <td><%= f.text_field :payment_due, :readonly => true, :color => 'black', :size => '12' %></td>
                <td>
                    <%= select_tag 'to_currency', options_for_select([['USD', 'USD'], ['INR', 'INR'], ['JPY', 'JPY'], ['CNY', 'CNY'], ['CAD', 'CAD']]) %> 
                </td>
                <td><%= text_field_tag 'converted_currency', '', :disabled=>true, :color => 'black', :size => '12' %></td>
            </tr>
            </table>
          </td>
        </tr>

    </table>


<p>
  <div class="actions">
    <%= f.submit "Update" %> 
    <%= submit_tag 'Cancel', :action => 'show' %>
  </div>
</p> 
 
<% end %>

